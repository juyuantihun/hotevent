<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hotech.events.mapper.TimelineEventMapper">

    <!-- 分页查询未关联到指定时间线的事件 -->
    <select id="selectAvailableEvents" resultType="java.util.Map">
        SELECT e.id, e.event_description, e.event_time, e.event_location,
               e.event_type, e.subject, e.object, e.relation_type,
               e.source_type, e.intensity_level, e.created_at, e.updated_at
        FROM event e
        LEFT JOIN timeline_event te ON e.id = te.event_id AND te.timeline_id = #{timelineId}
        WHERE te.event_id IS NULL
        <if test="eventType != null and eventType != ''">
            AND e.event_type = #{eventType}
        </if>
        <if test="subject != null and subject != ''">
            AND e.subject = #{subject}
        </if>
        <if test="object != null and object != ''">
            AND e.object = #{object}
        </if>
        <if test="sourceType != null">
            AND e.source_type = #{sourceType}
        </if>
        <if test="startTime != null">
            AND e.event_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND e.event_time &lt;= #{endTime}
        </if>
        ORDER BY e.event_time DESC
    </select>
    
    <!-- 调试查询：获取所有事件（用于测试搜索条件） -->
    <select id="selectAllEventsForDebug" resultType="java.util.Map">
        SELECT e.id, e.event_description, e.event_time, e.event_location,
               e.event_type, e.subject, e.object, e.relation_type,
               e.source_type, e.intensity_level, e.created_at, e.updated_at,
               CASE WHEN te.event_id IS NOT NULL THEN 1 ELSE 0 END as is_associated
        FROM event e
        LEFT JOIN timeline_event te ON e.id = te.event_id AND te.timeline_id = #{timelineId}
        WHERE 1=1
        <if test="eventType != null and eventType != ''">
            AND e.event_type = #{eventType}
        </if>
        <if test="subject != null and subject != ''">
            AND e.subject = #{subject}
        </if>
        <if test="object != null and object != ''">
            AND e.object = #{object}
        </if>
        <if test="sourceType != null">
            AND e.source_type = #{sourceType}
        </if>
        <if test="startTime != null">
            AND e.event_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND e.event_time &lt;= #{endTime}
        </if>
        ORDER BY e.event_time DESC
    </select>

</mapper>